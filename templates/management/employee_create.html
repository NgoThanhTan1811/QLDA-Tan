{% extends 'base/base.html' %}
{% load static %}

{% block title %}Thêm nhân viên mới{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .form-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background-color: #f8f9fa;
    }
    .section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        border-bottom: 2px solid #007bff;
        padding-bottom: 0.5rem;
    }
    .avatar-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #e9ecef;
    }
    .avatar-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px dashed #6c757d;
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-plus me-2"></i>Thêm nhân viên mới</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'main:dashboard' %}">Trang chủ</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'management:index' %}">Quản lý</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'management:employee_list' %}">Nhân viên</a></li>
                        <li class="breadcrumb-item active">Thêm mới</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="employeeForm">
        {% csrf_token %}
        <div class="row">
            <div class="col-lg-8">
                <!-- Thông tin cơ bản -->
                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-user me-2"></i>Thông tin cơ bản</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="employee_id" class="form-label required-field">Mã nhân viên</label>
                            <input type="text" class="form-control" id="employee_id" name="employee_id" 
                                   value="{{ form.employee_id.value|default:'' }}" required>
                            <small class="text-muted">Mã nhân viên duy nhất (ví dụ: EMP001)</small>
                            {% if form.employee_id.errors %}
                                <div class="text-danger">{{ form.employee_id.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Trạng thái</label>
                            <select class="form-select" id="status" name="is_active">
                                <option value="1" {% if form.is_active.value %}selected{% endif %}>Đang làm việc</option>
                                <option value="0" {% if not form.is_active.value %}selected{% endif %}>Đã nghỉ việc</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label required-field">Họ</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" 
                                   value="{{ form.first_name.value|default:'' }}" required>
                            {% if form.first_name.errors %}
                                <div class="text-danger">{{ form.first_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label required-field">Tên</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" 
                                   value="{{ form.last_name.value|default:'' }}" required>
                            {% if form.last_name.errors %}
                                <div class="text-danger">{{ form.last_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nickname" class="form-label">Tên thường gọi</label>
                            <input type="text" class="form-control" id="nickname" name="nickname" 
                                   value="{{ form.nickname.value|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gender" class="form-label">Giới tính</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="">Chọn giới tính</option>
                                <option value="male" {% if form.gender.value == 'male' %}selected{% endif %}>Nam</option>
                                <option value="female" {% if form.gender.value == 'female' %}selected{% endif %}>Nữ</option>
                                <option value="other" {% if form.gender.value == 'other' %}selected{% endif %}>Khác</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="date_of_birth" class="form-label">Ngày sinh</label>
                            <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" 
                                   value="{{ form.date_of_birth.value|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="national_id" class="form-label">CMND/CCCD</label>
                            <input type="text" class="form-control" id="national_id" name="national_id" 
                                   value="{{ form.national_id.value|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Thông tin liên hệ -->
                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-phone me-2"></i>Thông tin liên hệ</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label required-field">Email</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="{{ form.email.value|default:'' }}" required>
                            {% if form.email.errors %}
                                <div class="text-danger">{{ form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label required-field">Số điện thoại</label>
                            <input type="tel" class="form-control" id="phone" name="phone" 
                                   value="{{ form.phone.value|default:'' }}" required>
                            {% if form.phone.errors %}
                                <div class="text-danger">{{ form.phone.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Địa chỉ</label>
                        <textarea class="form-control" id="address" name="address" rows="3">{{ form.address.value|default:'' }}</textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="emergency_contact_name" class="form-label">Người liên hệ khẩn cấp</label>
                            <input type="text" class="form-control" id="emergency_contact_name" name="emergency_contact_name" 
                                   value="{{ form.emergency_contact_name.value|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="emergency_contact_phone" class="form-label">SĐT người liên hệ khẩn cấp</label>
                            <input type="tel" class="form-control" id="emergency_contact_phone" name="emergency_contact_phone" 
                                   value="{{ form.emergency_contact_phone.value|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Thông tin công việc -->
                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-briefcase me-2"></i>Thông tin công việc</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="department" class="form-label required-field">Phòng ban</label>
                            <select class="form-select" id="department" name="department" required>
                                <option value="">Chọn phòng ban</option>
                                <option value="sales" {% if form.department.value == 'sales' %}selected{% endif %}>Kinh doanh</option>
                                <option value="warehouse" {% if form.department.value == 'warehouse' %}selected{% endif %}>Kho</option>
                                <option value="admin" {% if form.department.value == 'admin' %}selected{% endif %}>Hành chính</option>
                                <option value="finance" {% if form.department.value == 'finance' %}selected{% endif %}>Tài chính</option>
                                <option value="it" {% if form.department.value == 'it' %}selected{% endif %}>Công nghệ thông tin</option>
                                <option value="hr" {% if form.department.value == 'hr' %}selected{% endif %}>Nhân sự</option>
                            </select>
                            {% if form.department.errors %}
                                <div class="text-danger">{{ form.department.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="position" class="form-label required-field">Chức vụ</label>
                            <select class="form-select" id="position" name="position" required>
                                <option value="">Chọn chức vụ</option>
                                <option value="manager" {% if form.position.value == 'manager' %}selected{% endif %}>Quản lý</option>
                                <option value="supervisor" {% if form.position.value == 'supervisor' %}selected{% endif %}>Giám sát</option>
                                <option value="staff" {% if form.position.value == 'staff' %}selected{% endif %}>Nhân viên</option>
                                <option value="intern" {% if form.position.value == 'intern' %}selected{% endif %}>Thực tập sinh</option>
                            </select>
                            {% if form.position.errors %}
                                <div class="text-danger">{{ form.position.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="hire_date" class="form-label required-field">Ngày vào làm</label>
                            <input type="date" class="form-control" id="hire_date" name="hire_date" 
                                   value="{{ form.hire_date.value|default:'' }}" required>
                            {% if form.hire_date.errors %}
                                <div class="text-danger">{{ form.hire_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="salary" class="form-label">Lương cơ bản</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="salary" name="salary" 
                                       value="{{ form.salary.value|default:'' }}" min="0">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="job_description" class="form-label">Mô tả công việc</label>
                        <textarea class="form-control" id="job_description" name="job_description" rows="3">{{ form.job_description.value|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Ảnh đại diện -->
                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-image me-2"></i>Ảnh đại diện</h5>
                    <div class="text-center mb-3">
                        <div id="avatarPreview" class="avatar-placeholder mx-auto">
                            <i class="fas fa-camera fa-2x text-muted"></i>
                        </div>
                    </div>
                    <div class="mb-3">
                        <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*" onchange="previewAvatar(this)">
                        <small class="text-muted">Chấp nhận file JPG, PNG. Kích thước tối đa: 5MB</small>
                    </div>
                </div>

                <!-- Thông tin bổ sung -->
                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-info-circle me-2"></i>Thông tin bổ sung</h5>
                    <div class="mb-3">
                        <label for="education_level" class="form-label">Trình độ học vấn</label>
                        <select class="form-select" id="education_level" name="education_level">
                            <option value="">Chọn trình độ</option>
                            <option value="high_school" {% if form.education_level.value == 'high_school' %}selected{% endif %}>Trung học phổ thông</option>
                            <option value="college" {% if form.education_level.value == 'college' %}selected{% endif %}>Cao đẳng</option>
                            <option value="university" {% if form.education_level.value == 'university' %}selected{% endif %}>Đại học</option>
                            <option value="master" {% if form.education_level.value == 'master' %}selected{% endif %}>Thạc sĩ</option>
                            <option value="doctor" {% if form.education_level.value == 'doctor' %}selected{% endif %}>Tiến sĩ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="marital_status" class="form-label">Tình trạng hôn nhân</label>
                        <select class="form-select" id="marital_status" name="marital_status">
                            <option value="">Chọn tình trạng</option>
                            <option value="single" {% if form.marital_status.value == 'single' %}selected{% endif %}>Độc thân</option>
                            <option value="married" {% if form.marital_status.value == 'married' %}selected{% endif %}>Đã kết hôn</option>
                            <option value="divorced" {% if form.marital_status.value == 'divorced' %}selected{% endif %}>Đã ly hôn</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bank_account" class="form-label">Số tài khoản ngân hàng</label>
                        <input type="text" class="form-control" id="bank_account" name="bank_account" 
                               value="{{ form.bank_account.value|default:'' }}">
                    </div>
                    <div class="mb-3">
                        <label for="bank_name" class="form-label">Tên ngân hàng</label>
                        <input type="text" class="form-control" id="bank_name" name="bank_name" 
                               value="{{ form.bank_name.value|default:'' }}">
                    </div>
                </div>

                <!-- Ghi chú -->
                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-sticky-note me-2"></i>Ghi chú</h5>
                    <div class="mb-3">
                        <textarea class="form-control" id="notes" name="notes" rows="4" placeholder="Ghi chú thêm về nhân viên...">{{ form.notes.value|default:'' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{% url 'management:employee_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i>Hủy
                    </a>
                    <button type="reset" class="btn btn-outline-warning">
                        <i class="fas fa-undo me-1"></i>Reset
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i>Lưu nhân viên
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
function previewAvatar(input) {
    const preview = document.getElementById('avatarPreview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="avatar-preview">`;
        };
        
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.innerHTML = '<i class="fas fa-camera fa-2x text-muted"></i>';
    }
}

// Auto generate employee ID
document.getElementById('first_name').addEventListener('input', generateEmployeeId);
document.getElementById('last_name').addEventListener('input', generateEmployeeId);

function generateEmployeeId() {
    const firstName = document.getElementById('first_name').value;
    const lastName = document.getElementById('last_name').value;
    const employeeIdField = document.getElementById('employee_id');
    
    if (firstName && lastName && !employeeIdField.value) {
        const initials = firstName.charAt(0).toUpperCase() + lastName.charAt(0).toUpperCase();
        const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        employeeIdField.value = `EMP${initials}${randomNum}`;
    }
}

// Form validation
document.getElementById('employeeForm').addEventListener('submit', function(e) {
    const requiredFields = document.querySelectorAll('input[required], select[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Vui lòng điền đầy đủ các trường bắt buộc!');
    }
});

// Email validation
document.getElementById('email').addEventListener('blur', function() {
    const email = this.value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email && !emailRegex.test(email)) {
        this.classList.add('is-invalid');
        if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('invalid-feedback')) {
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = 'Email không hợp lệ';
            this.parentNode.appendChild(feedback);
        }
    } else {
        this.classList.remove('is-invalid');
        const feedback = this.parentNode.querySelector('.invalid-feedback');
        if (feedback) feedback.remove();
    }
});

// Phone validation
document.getElementById('phone').addEventListener('blur', function() {
    const phone = this.value;
    const phoneRegex = /^[0-9+\-\s\(\)]+$/;
    
    if (phone && !phoneRegex.test(phone)) {
        this.classList.add('is-invalid');
        if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('invalid-feedback')) {
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = 'Số điện thoại không hợp lệ';
            this.parentNode.appendChild(feedback);
        }
    } else {
        this.classList.remove('is-invalid');
        const feedback = this.parentNode.querySelector('.invalid-feedback');
        if (feedback) feedback.remove();
    }
});
</script>
{% endblock %}
