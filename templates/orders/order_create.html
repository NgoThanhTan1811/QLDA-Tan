{% extends 'base/base.html' %}
{% load static %}

{% block title %}Tạo đơn hàng mới{% endblock %}

{% block extra_css %}
<style>
    .product-search-results {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 0.375rem;
        background: white;
        z-index: 1000;
    }
    .product-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .product-item:hover {
        background-color: #f8f9fa;
    }
    .product-item:last-child {
        border-bottom: none;
    }
    .order-total {
        font-size: 1.2em;
        font-weight: bold;
        color: #28a745;
    }
    .product-row {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
    }
    .product-row:last-child {
        border-bottom: none;
    }
    .quantity-input {
        max-width: 100px;
    }
    .remove-product {
        color: #dc3545;
        cursor: pointer;
    }
    .stock-info {
        font-size: 0.9em;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shopping-cart me-2"></i>Tạo đơn hàng mới</h2>
                <a href="{% url 'orders:list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
            </div>

            <form method="post" id="orderForm">
                {% csrf_token %}
                <div class="row">
                    <!-- Order Information -->
                    <div class="col-lg-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin đơn hàng</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="order_type" class="form-label">Loại đơn hàng <span class="text-danger">*</span></label>
                                            <select class="form-select" id="order_type" name="order_type" required>
                                                <option value="sale">Bán hàng cho khách hàng</option>
                                                <option value="purchase">Mua hàng từ nông dân</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                        <label for="customer" class="form-label">Khách hàng *</label>
                                        <select id="customer" name="customer" class="form-select" required>
                                            <option value="">Chọn khách hàng</option>
                                            {% for c in customers %}
                                            <option
                                                value="{{ c.id }}"
                                                data-contact="{{ c.contact_person }}"
                                                data-phone="{{ c.phone }}"
                                                data-email="{{ c.email }}"
                                            >
                                                {{ c.customer_code }} – {{ c.full_name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="order_date" class="form-label">Ngày đặt hàng</label>
                                            <input type="date" class="form-control" id="order_date" name="order_date" 
                                                   value="{{ today|date:'Y-m-d' }}" required>
                                        </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="delivery_date" class="form-label">Ngày giao hàng dự kiến</label>
                                            <input type="date" class="form-control" id="delivery_date" name="delivery_date">
                                        </div>
                                    </div>
                                </div>

                                <!-- Customer Contact Info -->
                                <div class="row" id="customerInfo" style="display: none;">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <h6>Thông tin liên hệ:</h6>
                                            <p class="mb-1"><strong>Người liên hệ:</strong> <span id="contactPerson"></span></p>
                                            <p class="mb-1"><strong>Điện thoại:</strong> <span id="contactPhone"></span></p>
                                            <p class="mb-0"><strong>Email:</strong> <span id="contactEmail"></span></p>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="shipping_address" class="form-label">Địa chỉ giao hàng</label>
                                    <textarea class="form-control" id="shipping_address" name="shipping_address" rows="3"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="notes" class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="Ghi chú thêm về đơn hàng..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Products Section -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-box me-2"></i>Sản phẩm đặt hàng</h5>
                            </div>
                            <div class="card-body">
                                <!-- Add Product Search -->
                                <div class="mb-4">
                                    <label for="productSearch" class="form-label">Thêm sản phẩm</label>
                                    <div class="position-relative">
                                        <input type="text" class="form-control" id="productSearch" 
                                               placeholder="Tìm kiếm sản phẩm theo tên hoặc mã...">
                                        <div id="productSearchResults" class="product-search-results position-absolute w-100" style="display: none;"></div>
                                    </div>
                                </div>

                                <!-- Selected Products -->
                                <div id="selectedProducts">
                                    <div class="text-center text-muted py-4" id="emptyProductMessage">
                                        <i class="fas fa-box-open fa-3x mb-3"></i>
                                        <p>Chưa có sản phẩm nào được chọn</p>
                                        <p class="small">Sử dụng ô tìm kiếm phía trên để thêm sản phẩm</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="col-lg-4">
                        <div class="card sticky-top" style="top: 20px;">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Tổng kết đơn hàng</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tổng sản phẩm:</span>
                                    <span id="totalItems">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tạm tính:</span>
                                    <span id="subtotal">0 ₫</span>
                                </div>
                                <div class="mb-3">
                                    <label for="discount" class="form-label">Giảm giá (%)</label>
                                    <input type="number" class="form-control" id="discount" name="discount" 
                                           min="0" max="100" value="0" step="0.1">
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Giảm giá:</span>
                                    <span id="discountAmount">0 ₫</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between order-total">
                                    <span>Tổng cộng:</span>
                                    <span id="totalAmount">0 ₫</span>
                                </div>

                                <hr>
                                
                                <div class="mb-3">
                                    <label for="payment_method" class="form-label">Phương thức thanh toán</label>
                                    <select class="form-select" id="payment_method" name="payment_method">
                                        <option value="cash">Tiền mặt</option>
                                        <option value="bank_transfer">Chuyển khoản</option>
                                        <option value="credit">Trả góp</option>
                                        <option value="cod">Thu hộ (COD)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="payment_status" class="form-label">Trạng thái thanh toán</label>
                                    <select class="form-select" id="payment_status" name="payment_status">
                                        <option value="pending">Chờ thanh toán</option>
                                        <option value="partial">Thanh toán một phần</option>
                                        <option value="paid">Đã thanh toán</option>
                                    </select>
                                </div>

                                <button type="submit" class="btn btn-primary w-100" id="submitBtn" >
                                    <i class="fas fa-save me-2"></i>Tạo đơn hàng
                                </button>
                                
                                <!-- Hidden fields for totals -->
                                <input type="hidden" name="subtotal" id="hiddenSubtotal" value="0">
                                <input type="hidden" name="discount_amount" id="hiddenDiscountAmount" value="0">
                                <input type="hidden" name="total_amount" id="hiddenTotalAmount" value="0">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden template for product row -->
<template id="productRowTemplate">
    <div class="product-row" data-product-id="">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h6 class="mb-1 product-name"></h6>
                <p class="mb-0 text-muted small product-code"></p>
                <p class="mb-0 stock-info"></p>
            </div>
            <div class="col-md-2">
                <small class="text-muted">Đơn giá</small>
                <div class="product-price"></div>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Số lượng</label>
                <div class="input-group">
                    <button type="button" class="btn btn-outline-secondary btn-sm decrease-qty">-</button>
                    <input type="number" class="form-control form-control-sm quantity-input text-center" 
                           min="1" value="1">
                    <button type="button" class="btn btn-outline-secondary btn-sm increase-qty">+</button>
                </div>
            </div>
            <div class="col-md-2">
                <small class="text-muted">Thành tiền</small>
                <div class="product-total"></div>
            </div>
            <div class="col-md-1 text-end">
                <i class="fas fa-times remove-product" title="Xóa sản phẩm"></i>
            </div>
        </div>
        <input type="hidden" name="products" value="">
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
let selectedProducts = [];
let products = JSON.parse('{{ products|escapejs }}') || [];

console.log('Products loaded:', products); // Debug line

// Customer selection change
document.getElementById('customer').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    const customerInfo = document.getElementById('customerInfo');
    
    if (selected.value) {
        document.getElementById('contactPerson').textContent = selected.dataset.contact || 'Không có';
        document.getElementById('contactPhone').textContent = selected.dataset.phone || 'Không có';
        document.getElementById('contactEmail').textContent = selected.dataset.email || 'Không có';
        customerInfo.style.display = 'block';
    } else {
        customerInfo.style.display = 'none';
    }
});

// Product search
document.getElementById('productSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    const resultsDiv = document.getElementById('productSearchResults');
    
    if (searchTerm.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    const filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(searchTerm) ||
        product.code.toLowerCase().includes(searchTerm)
    ).filter(product => 
        !selectedProducts.find(sp => sp.id === product.id)
    );
    
    if (filteredProducts.length > 0) {
        resultsDiv.innerHTML = filteredProducts.map(product => `
            <div class="product-item" onclick="addProduct(${product.id})">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${product.name}</strong>
                        <br><small class="text-muted">${product.code}</small>
                    </div>
                    <div class="text-end">
                        <div>${formatCurrency(product.price)}</div>
                        <small class="text-muted">Tồn: ${product.stock || 0} ${product.unit}</small>
                    </div>
                </div>
            </div>
        `).join('');
        resultsDiv.style.display = 'block';
    } else {
        resultsDiv.innerHTML = '<div class="product-item text-muted">Không tìm thấy sản phẩm nào</div>';
        resultsDiv.style.display = 'block';
    }
});

// Hide search results when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.position-relative')) {
        document.getElementById('productSearchResults').style.display = 'none';
    }
});

function addProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product || selectedProducts.find(sp => sp.id === productId)) return;
    
    selectedProducts.push({
        id: product.id,
        name: product.name,
        code: product.code,
        price: product.price,
        unit: product.unit,
        stock: product.stock || 0,
        quantity: 1
    });
    
    renderProducts();
    updateOrderSummary();
    
    // Clear search
    document.getElementById('productSearch').value = '';
    document.getElementById('productSearchResults').style.display = 'none';
}

function removeProduct(productId) {
    selectedProducts = selectedProducts.filter(p => p.id !== productId);
    renderProducts();
    updateOrderSummary();
}

function updateQuantity(productId, quantity) {
    const product = selectedProducts.find(p => p.id === productId);
    if (product) {
        product.quantity = Math.max(1, quantity);
        updateOrderSummary();
    }
}

function renderProducts() {
    const container = document.getElementById('selectedProducts');
    const template = document.getElementById('productRowTemplate');
    const emptyMessage = document.getElementById('emptyProductMessage');
    
    if (selectedProducts.length === 0) {
        container.innerHTML = '';
        container.appendChild(emptyMessage.cloneNode(true));
        return;
    }
    
    container.innerHTML = selectedProducts.map(product => {
        const clone = template.content.cloneNode(true);
        const row = clone.querySelector('.product-row');
        
        row.dataset.productId = product.id;
        row.querySelector('.product-name').textContent = product.name;
        row.querySelector('.product-code').textContent = `Mã: ${product.code}`;
        row.querySelector('.stock-info').textContent = `Tồn kho: ${product.stock} ${product.unit}`;
        row.querySelector('.product-price').textContent = formatCurrency(product.price);
        row.querySelector('.quantity-input').value = product.quantity;
        row.querySelector('.product-total').textContent = formatCurrency(product.price * product.quantity);
        row.querySelector('input[name="products"]').value = JSON.stringify({
            id: product.id,
            quantity: product.quantity,
            price: product.price
        });
        
        return row.outerHTML;
    }).join('');
    
    // Reattach event listeners
    attachProductEventListeners();
}

function attachProductEventListeners() {
    // Quantity change
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            const productId = parseInt(this.closest('.product-row').dataset.productId);
            updateQuantity(productId, parseInt(this.value));
            renderProducts();
        });
    });
    
    // Increase/decrease quantity
    document.querySelectorAll('.increase-qty').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.previousElementSibling;
            const productId = parseInt(this.closest('.product-row').dataset.productId);
            const newQty = parseInt(input.value) + 1;
            updateQuantity(productId, newQty);
            renderProducts();
        });
    });
    
    document.querySelectorAll('.decrease-qty').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.nextElementSibling;
            const productId = parseInt(this.closest('.product-row').dataset.productId);
            const newQty = Math.max(1, parseInt(input.value) - 1);
            updateQuantity(productId, newQty);
            renderProducts();
        });
    });
    
    // Remove product
    document.querySelectorAll('.remove-product').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.closest('.product-row').dataset.productId);
            removeProduct(productId);
        });
    });
}

function updateOrderSummary() {
    const subtotal = selectedProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const discountAmount = subtotal * (discount / 100);
    const total = subtotal - discountAmount;
    
    document.getElementById('totalItems').textContent = selectedProducts.length;
    document.getElementById('subtotal').textContent = formatCurrency(subtotal);
    document.getElementById('discountAmount').textContent = formatCurrency(discountAmount);
    document.getElementById('totalAmount').textContent = formatCurrency(total);
    
    // Update hidden fields
    document.getElementById('hiddenSubtotal').value = subtotal;
    document.getElementById('hiddenDiscountAmount').value = discountAmount;
    document.getElementById('hiddenTotalAmount').value = total;
    
    // Enable/disable submit button
    const submitBtn = document.getElementById('submitBtn');
    const hasCustomer = document.getElementById('customer').value;
    const hasOrderType = document.getElementById('order_type').value;
    const hasProducts = selectedProducts.length > 0;
    
    submitBtn.disabled = !(hasCustomer && hasOrderType && hasProducts);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(amount);
}

// Discount change
document.getElementById('discount').addEventListener('input', updateOrderSummary);

// Form validation
document.getElementById('customer').addEventListener('change', updateOrderSummary);
document.getElementById('order_type').addEventListener('change', updateOrderSummary);

// Initialize
updateOrderSummary();
</script>
{% endblock %}
